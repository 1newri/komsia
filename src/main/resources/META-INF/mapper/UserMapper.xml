<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.komsia.kom.mapper.UserMapper">
	
	<resultMap type="UserVO" id="user">
		<result column="USER_NO" jdbcType="DECIMAL" property="userNo" />
		<result column="USER_ID" jdbcType="VARCHAR" property="userId" />
		<result column="PASSWORD" jdbcType="VARCHAR" property="password" />
		<result column="USER_NAME" jdbcType="VARCHAR" property="userName" />
		<result column="TEL" jdbcType="VARCHAR" property="tel" />
		<result column="SEX" jdbcType="CHAR" property="sex" />
		<result column="EMAIL" jdbcType="VARCHAR" property="email" />
		<result column="BIRTH" jdbcType="VARCHAR" property="birth" />
		<collection property="userRoles" column="userRoles" javaType="ArrayList" ofType="Authorities">
			<id column="ROLE_ID" jdbcType="DECIMAL" property="id"/>
			<collection property="role" column="role" ofType="Role">
				<id column="ROLE_ID" jdbcType="DECIMAL" property="roleId"/>
				<result column="ROLE_NAME" jdbcType="VARCHAR" property="roleName"/>
			</collection>
		</collection>
	</resultMap>
	
	<select id="selectUserByUserId" parameterType="String" resultMap="user">
		SELECT 
			U.USER_NO
		    , U.USER_ID
		    , R.ROLE_ID
		    , R.ROLE_NAME
		    , PASSWORD
		    , USER_NAME
		    , TEL
		    , SEX
		    , EMAIL
		    , BIRTH
		FROM komsia.ks_user U
		LEFT JOIN komsia.ks_auth_authorities A
			ON U.user_no = A.user_no
		LEFT JOIN komsia.ks_auth_role R
			ON A.ROLE_ID = R.ROLE_ID
		WHERE U.USER_ID = #{userId}
	</select>
	
	
	<insert id="joinUser" parameterType="UserVO">
		INSERT INTO ks_user (
			USER_ID
			, PASSWORD
			, USER_NAME
			, TEL
			, SEX
			, EMAIL
			, BIRTH
		) VALUES (
			#{userId}
			, #{password}
			, #{userName}
			, #{tel}
			, #{sex}
			, #{email}
			, #{birth}
		)
		<selectKey keyProperty="userNo" resultType="Long" order="AFTER">
            SELECT 
            	USER_NO AS userNo 
            FROM ks_user 
			WHERE USER_ID = #{userId}
		</selectKey>
	</insert>
	
	<insert id="insertAuthUser" parameterType="String">
		INSERT INTO ks_auth_authorities(
			USER_NO
			, ROLE_ID
		) VALUES (
			#{userNo}
			, #{roleId}		
		)
	</insert>
	
	<select id="selectUserList" resultType="UserVO">
		SELECT
			USER_NO
			, USER_ID
			, USER_NAME
			, TEL
			, EMAIL
			, REG_DTTM
			, USE_YN
		FROM ks_user
	</select>
	
	<delete id="deleteAuthUser" parameterType="String">
		DELETE FROM ks_auth_authorities
		WHERE USER_NO = #{userNo}
		AND ROLE_ID = #{roleId}
	</delete>
	
	<update id="updateUserPassword" parameterType="UserVO">
		UPDATE ks_user SET
			PASSWORD = #{password}
			, MOD_ID = #{modId}
			, MOD_DTTM = NOW()
		WHERE USER_ID = #{userId}			
	</update>
	
	<update id="updateUser" parameterType="UserVO">
		UPDATE ks_user SET
			MOD_ID = #{modId}
			, MOD_DTTM = NOW()
			<if test="tel != null and tel != ''">
				, TEL = #{tel}
			</if>
			<if test="email != null and email != ''">
			, EMAIL = #{email}
			</if>
			<if test="birth != null and birth != ''">
			, BIRTH = #{birth}
			</if>
		WHERE USER_ID = #{userId}			
	</update>
</mapper>